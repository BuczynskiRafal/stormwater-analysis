{% extends "base.html" %}
{% load static %}
{% load confidence_filters %}

{% block title %}{{ data_type|title }} Detail - Session {{ session.id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- Navigation Arrows -->
    <div class="navigation-arrows">
        {% if navigation.previous and navigation.previous.url %}
        <div class="nav-arrow nav-arrow-left" id="navArrowLeft">
            <a href="{{ navigation.previous.url }}" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"></path>
                </svg>
                <span class="nav-tooltip">Previous: {{ navigation.previous.name }}</span>
            </a>
        </div>
        {% endif %}

        {% if navigation.next and navigation.next.url %}
        <div class="nav-arrow nav-arrow-right" id="navArrowRight">
            <a href="{{ navigation.next.url }}" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"></path>
                </svg>
                <span class="nav-tooltip">Next: {{ navigation.next.name }}</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Session Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ data_type|title }} Detail:
                        {% if data_type == "conduit" %}{{ conduit.conduit_name }}{% endif %}
                        {% if data_type == "node" %}{{ node.node_name }}{% endif %}
                        {% if data_type == "subcatchment" %}{{ subcatchment.subcatchment_name }}{% endif %}
                    </h4>
                    <div class="d-flex gap-2">
                        <a href="{% url 'sa:analysis_results' session.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Results
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Session:</strong> Session {{ session.id }}
                        </div>
                        <div class="col-md-4">
                            <strong>Created:</strong> {{ session.created_at|date:"M d, Y H:i" }}
                        </div>
                        <div class="col-md-4">
                            <strong>Frost Zone:</strong> {{ session.frost_zone }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Main Data Panel -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        {% if data_type == "conduit" %}Conduit{% endif %}
                        {% if data_type == "node" %}Node{% endif %}
                        {% if data_type == "subcatchment" %}Subcatchment{% endif %}
                        Properties
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Property</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if data_type == "conduit" %}
                                    <tr><td><strong>Name</strong></td><td>{{ conduit.conduit_name }}</td></tr>
                                    <tr><td>Inlet Node</td><td>{{ conduit.inlet_node }}</td></tr>
                                    <tr><td>Outlet Node</td><td>{{ conduit.outlet_node }}</td></tr>
                                    <tr><td>Length</td><td>{{ conduit.length|floatformat:2 }} m</td></tr>
                                    <tr><td>Diameter</td><td>{{ conduit.geom1|floatformat:2 }} m</td></tr>
                                    <tr><td>Max Velocity</td><td>{{ conduit.max_v|floatformat:2 }} m/s</td></tr>
                                    <tr><td>Filling</td><td>{{ conduit.filling|floatformat:2 }}%</td></tr>
                                    <tr><td>Slope</td><td>{{ conduit.slope_per_mile|floatformat:4 }}‰</td></tr>
                                    <tr><td>Min Required Slope</td><td>{{ conduit.min_required_slope|floatformat:4 }}‰</td></tr>
                                    <tr><td>Max Allowable Slope</td><td>{{ conduit.max_allowable_slope|floatformat:4 }}‰</td></tr>
                                    <tr><td>Inlet Ground Elevation</td><td>{{ conduit.inlet_ground_elevation|floatformat:2 }} m</td></tr>
                                    <tr><td>Outlet Ground Elevation</td><td>{{ conduit.outlet_ground_elevation|floatformat:2 }} m</td></tr>
                                    <tr><td>Inlet Ground Cover</td><td>{{ conduit.inlet_ground_cover|floatformat:2 }} m</td></tr>
                                    <tr><td>Outlet Ground Cover</td><td>{{ conduit.outlet_ground_cover|floatformat:2 }} m</td></tr>
                                    <tr><td>Subcatchment</td><td>{{ conduit.subcatchment }}</td></tr>
                                    <tr><td>Subcatchment Category</td><td>{{ conduit.sbc_category }}</td></tr>
                                    <tr><td>Recommendation</td><td>{{ conduit.recommendation }}</td></tr>
                                {% endif %}

                                {% if data_type == "node" %}
                                    <tr><td><strong>Name</strong></td><td>{{ node.node_name }}</td></tr>
                                    <tr><td>Elevation</td><td>{{ node.elevation|floatformat:2 }} m</td></tr>
                                    <tr><td>Max Depth</td><td>{{ node.max_depth|floatformat:2 }} m</td></tr>
                                    <tr><td>Init Depth</td><td>{{ node.init_depth|floatformat:2 }} m</td></tr>
                                    <tr><td>Surcharge Depth</td><td>{{ node.surcharge_depth|floatformat:2 }} m</td></tr>
                                    <tr><td>Ponded Area</td><td>{{ node.ponded_area|floatformat:2 }} m²</td></tr>
                                {% endif %}

                                {% if data_type == "subcatchment" %}
                                    <tr><td><strong>Name</strong></td><td>{{ subcatchment.subcatchment_name }}</td></tr>
                                    <tr><td>Rain Gauge</td><td>{{ subcatchment.rain_gauge }}</td></tr>
                                    <tr><td>Outlet</td><td>{{ subcatchment.outlet }}</td></tr>
                                    <tr><td>Area</td><td>{{ subcatchment.area|floatformat:2 }} ha</td></tr>
                                    <tr><td>Imperviousness</td><td>{{ subcatchment.imperviousness|floatformat:1 }}%</td></tr>
                                    <tr><td>Width</td><td>{{ subcatchment.width|floatformat:2 }} m</td></tr>
                                    <tr><td>Slope</td><td>{{ subcatchment.slope|floatformat:3 }}%</td></tr>
                                    <tr><td>Curve Number</td><td>{{ subcatchment.curve_number|floatformat:1 }}</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar with Related Data -->
        <div class="col-lg-4">
            {% if data_type == "conduit" %}
                <!-- Binary Validation Results -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-clipboard-check me-2"></i>
                            Binary Validation Results
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Validation Summary -->
                        <div class="mb-3">
                            {% with total_checks=7 passed_checks=conduit.val_max_fill|add:conduit.val_max_v|add:conduit.val_min_v|add:conduit.val_max_slope|add:conduit.val_min_slope|add:conduit.val_depth|add:conduit.val_coverage %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Overall Status:</strong>
                                <span class="badge bg-{% if passed_checks == total_checks %}success{% elif passed_checks >= 5 %}warning{% else %}danger{% endif %} fs-6">
                                    {{ passed_checks }}/{{ total_checks }} Passed
                                </span>
                            </div>
                            <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar bg-{% if passed_checks == total_checks %}success{% elif passed_checks >= 5 %}warning{% else %}danger{% endif %}"
                                     style="width: {% widthratio passed_checks total_checks 100 %}%"></div>
                            </div>
                            {% endwith %}
                        </div>

                        <!-- Individual Validation Results -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_max_fill %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_max_fill %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Max Filling</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_max_fill %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_max_fill %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_max_v %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_max_v %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Max Velocity</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_max_v %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_max_v %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_min_v %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_min_v %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Min Velocity</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_min_v %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_min_v %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_max_slope %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_max_slope %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Max Slope</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_max_slope %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_max_slope %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_min_slope %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_min_slope %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Min Slope</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_min_slope %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_min_slope %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_depth %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_depth %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Depth</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_depth %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_depth %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_coverage %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_coverage %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Coverage</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_coverage %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_coverage %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technical Recommendations -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Technical Recommendations
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Diameter Recommendations -->
                        <div class="mb-4 ">
                            <h6 class="mb-3 ">
                                <i class="fas fa-circle me-1"></i>
                                Diameter Analysis
                            </h6>

                            <div class="row g-3">
                                <!-- Current vs Minimum Required -->
                                <div class="col-12">
                                    <div class="card border-left-secondary">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold">Current Diameter</span>
                                                <span class="badge bg-secondary fs-6">{{ conduit.geom1|floatformat:3 }} m</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold">Minimum Required</span>
                                                <span class="badge bg-info fs-6">{{ conduit.min_diameter|floatformat:3 }} m</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                {% if conduit.geom1 >= conduit.min_diameter %}
                                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                                {% else %}
                                                    <div class="progress-bar bg-danger" style="width: {% widthratio conduit.geom1 conduit.min_diameter 100 %}%"></div>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">
                                                {% if conduit.geom1 >= conduit.min_diameter %}
                                                    ✓ Current diameter meets minimum requirements
                                                {% else %}
                                                    ⚠️ Current diameter below minimum required
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Diameter Recommendations -->
                                <div class="col-md-6">
                                    <div class="p-3 rounded border {% if conduit.increase_dia %}bg-warning-subtle border-warning{% else %}bg-light{% endif %}">
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-{% if conduit.increase_dia %}arrow-up text-warning{% else %}equals text-muted{% endif %} me-2"></i>
                                                <span class="fw-bold">Increase Diameter</span>
                                            </div>
                                            <span class="badge bg-{% if conduit.increase_dia %}warning{% else %}success{% endif %}">
                                                {% if conduit.increase_dia %}REQUIRED{% else %}NOT NEEDED{% endif %}
                                            </span>
                                        </div>
                                        {% if conduit.increase_dia %}
                                        <small class="text-muted">
                                            Suggested: {{ conduit.min_diameter|floatformat:3 }} m
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="p-3 rounded border {% if conduit.reduce_dia %}bg-info-subtle border-info{% else %}bg-light{% endif %}">
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-{% if conduit.reduce_dia %}arrow-down text-info{% else %}equals text-muted{% endif %} me-2"></i>
                                                <span class="fw-bold">Reduce Diameter</span>
                                            </div>
                                            <span class="badge bg-{% if conduit.reduce_dia %}info{% else %}success{% endif %}">
                                                {% if conduit.reduce_dia %}POSSIBLE{% else %}NOT POSSIBLE{% endif %}
                                            </span>
                                        </div>
                                        {% if conduit.reduce_dia %}
                                        <small class="text-muted">
                                            Minimum: {{ conduit.min_diameter|floatformat:3 }} m
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Slope Recommendations -->
                        <div class="mb-3">
                            <h6 class="mb-3">
                                <i class="fas fa-chart-line me-1"></i>
                                Slope Analysis
                            </h6>

                            <div class="row g-3">
                                <!-- Current vs Required Range -->
                                <div class="col-12">
                                    <div class="card border-left-secondary">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold">Current Slope</span>
                                                <span class="badge bg-secondary fs-6">{{ conduit.slope_per_mile|floatformat:4 }}‰</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold">Required Range</span>
                                                <span class="badge bg-success fs-6">{{ conduit.min_required_slope|floatformat:4 }}‰ - {{ conduit.max_allowable_slope|floatformat:4 }}‰</span>
                                            </div>
                                            <div class="position-relative">
                                                <div class="progress mb-2" style="height: 8px;">
                                                    {% if conduit.slope_per_mile >= conduit.min_required_slope and conduit.slope_per_mile <= conduit.max_allowable_slope %}
                                                        <div class="progress-bar bg-success" style="width: 100%"></div>
                                                    {% elif conduit.slope_per_mile < conduit.min_required_slope %}
                                                        <div class="progress-bar bg-danger" style="width: {% widthratio conduit.slope_per_mile conduit.min_required_slope 100 %}%"></div>
                                                    {% else %}
                                                        <div class="progress-bar bg-warning" style="width: 100%"></div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                {% if conduit.slope_per_mile >= conduit.min_required_slope and conduit.slope_per_mile <= conduit.max_allowable_slope %}
                                                    ✓ Current slope within acceptable range
                                                {% elif conduit.slope_per_mile < conduit.min_required_slope %}
                                                    ⚠️ Current slope below minimum required
                                                {% else %}
                                                    ⚠️ Current slope exceeds maximum allowable
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Slope Recommendations -->
                                <div class="col-md-6">
                                    <div class="p-3 rounded border {% if conduit.increase_slope %}bg-warning-subtle border-warning{% else %}bg-light{% endif %}">
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-{% if conduit.increase_slope %}trending-up text-warning{% else %}equals text-muted{% endif %} me-2"></i>
                                                <span class="fw-bold">Increase Slope</span>
                                            </div>
                                            <span class="badge bg-{% if conduit.increase_slope %}warning{% else %}success{% endif %}">
                                                {% if conduit.increase_slope %}REQUIRED{% else %}NOT NEEDED{% endif %}
                                            </span>
                                        </div>
                                        {% if conduit.increase_slope %}
                                        <small class="text-muted">
                                            Target: {{ conduit.min_required_slope|floatformat:4 }}‰
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="p-3 rounded border {% if conduit.reduce_slope %}bg-info-subtle border-info{% else %}bg-light{% endif %}">
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-{% if conduit.reduce_slope %}trending-down text-info{% else %}equals text-muted{% endif %} me-2"></i>
                                                <span class="fw-bold">Reduce Slope</span>
                                            </div>
                                            <span class="badge bg-{% if conduit.reduce_slope %}info{% else %}success{% endif %}">
                                                {% if conduit.reduce_slope %}REQUIRED{% else %}NOT POSSIBLE{% endif %}
                                            </span>
                                        </div>
                                        {% if conduit.reduce_slope %}
                                        <small class="text-muted">
                                            Target: {{ conduit.max_allowable_slope|floatformat:4 }}‰
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Neural Network Prediction Distribution -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-brain me-2"></i>
                            Neural Network Prediction Distribution
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Neural Network Confidence Scores -->
                        <div class="confidence-bars-container">
                            <!-- Pump -->
                            <div class="mb-3 {% if conduit.recommendation == 'pump' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Pump {% if conduit.recommendation == 'pump' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_pump|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_pump|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_pump|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Tank -->
                            <div class="mb-3 {% if conduit.recommendation == 'tank' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Tank {% if conduit.recommendation == 'tank' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_tank|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_tank|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_tank|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Seepage Boxes -->
                            <div class="mb-3 {% if conduit.recommendation == 'seepage_boxes' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Seepage Boxes {% if conduit.recommendation == 'seepage_boxes' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_seepage_boxes|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_seepage_boxes|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_seepage_boxes|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Diameter Increase -->
                            <div class="mb-3 {% if conduit.recommendation == 'diameter_increase' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Diameter Increase {% if conduit.recommendation == 'diameter_increase' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_diameter_increase|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_diameter_increase|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_diameter_increase|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Diameter Reduction -->
                            <div class="mb-3 {% if conduit.recommendation == 'diameter_reduction' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Diameter Reduction {% if conduit.recommendation == 'diameter_reduction' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_diameter_reduction|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_diameter_reduction|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_diameter_reduction|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Slope Increase -->
                            <div class="mb-3 {% if conduit.recommendation == 'slope_increase' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Slope Increase {% if conduit.recommendation == 'slope_increase' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_slope_increase|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_slope_increase|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_slope_increase|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Slope Reduction -->
                            <div class="mb-3 {% if conduit.recommendation == 'slope_reduction' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Slope Reduction {% if conduit.recommendation == 'slope_reduction' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_slope_reduction|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_slope_reduction|to_percent }}%; background-color: #6f42c1;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_slope_reduction|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Depth Increase -->
                            <div class="mb-3 {% if conduit.recommendation == 'depth_increase' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Depth Increase {% if conduit.recommendation == 'depth_increase' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_depth_increase|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar confidence-bar"
                                         style="width: {{ conduit.confidence_depth_increase|to_percent }}%; background-color: #fd7e14;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_depth_increase|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Valid (No Changes) -->
                            <div class="mb-3 {% if conduit.recommendation == 'valid' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Valid (No Changes) {% if conduit.recommendation == 'valid' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_valid|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_valid|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_valid|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
                </div>

                <!-- Connected Nodes -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Elements
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if inlet_node %}
                        <div class="mb-3">
                            <strong>Inlet Node:</strong><br>
                            <a href="{% url 'sa:node_detail' session.id inlet_node.node_name %}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-circle me-1"></i>{{ inlet_node.node_name }}
                            </a>
                        </div>
                        {% endif %}
                        {% if outlet_node %}
                        <div class="mb-3">
                            <strong>Outlet Node:</strong><br>
                            <a href="{% url 'sa:node_detail' session.id outlet_node.node_name %}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-circle me-1"></i>{{ outlet_node.node_name }}
                            </a>
                        </div>
                        {% endif %}
                        {% if subcatchment %}
                        <div class="mb-3">
                            <strong>Subcatchment:</strong><br>
                            <a href="{% url 'sa:subcatchment_detail' session.id subcatchment.subcatchment_name %}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-map me-1"></i>{{ subcatchment.subcatchment_name }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            {% if data_type == "node" %}
                <!-- Connected Conduits -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-road me-2"></i>
                            Connected Conduits
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_conduits %}
                            {% for conduit in related_conduits %}
                            <div class="mb-2">
                                <a href="{% url 'sa:conduit_detail' session.id conduit.conduit_name %}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="fas fa-road me-1"></i>{{ conduit.conduit_name }}
                                    {% if conduit.recommendation %}
                                    <span class="badge bg-warning text-dark ms-1">Rec</span>
                                    {% endif %}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No connected conduits found.</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            {% if data_type == "subcatchment" %}
                <!-- Connected Conduits -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-road me-2"></i>
                            Related Conduits
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_conduits %}
                            {% for conduit in related_conduits %}
                            <div class="mb-2">
                                <a href="{% url 'sa:conduit_detail' session.id conduit.conduit_name %}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="fas fa-road me-1"></i>{{ conduit.conduit_name }}
                                    {% if conduit.recommendation %}
                                    <span class="badge bg-warning text-dark ms-1">Rec</span>
                                    {% endif %}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No related conduits found.</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
        // Only handle arrow keys if we're not in an input field
        if (event.target.tagName.toLowerCase() === 'input' ||
            event.target.tagName.toLowerCase() === 'textarea' ||
            event.target.contentEditable === 'true') {
            return;
        }

        if (event.key === 'ArrowLeft') {
            event.preventDefault();
            const prevLink = document.querySelector('#navArrowLeft .nav-link');
            if (prevLink) {
                window.location.href = prevLink.href;
            }
        } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            const nextLink = document.querySelector('#navArrowRight .nav-link');
            if (nextLink) {
                window.location.href = nextLink.href;
            }
        }
    });

    // Enhanced hover effects for navigation areas
    const leftNavArea = document.getElementById('navArrowLeft');
    const rightNavArea = document.getElementById('navArrowRight');

    if (leftNavArea) {
        leftNavArea.addEventListener('mouseenter', function() {
            this.style.opacity = '1';
        });

        leftNavArea.addEventListener('mouseleave', function() {
            this.style.opacity = '0';
        });
    }

    if (rightNavArea) {
        rightNavArea.addEventListener('mouseenter', function() {
            this.style.opacity = '1';
        });

        rightNavArea.addEventListener('mouseleave', function() {
            this.style.opacity = '0';
        });
    }
});
</script>

{% endblock %}
