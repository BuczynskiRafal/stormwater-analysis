{% extends "base.html" %}
{% load static %}
{% load confidence_filters %}

{% block title %}{{ data_type|title }} Detail - Session {{ session.id }}{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- Navigation Arrows -->
    <div class="navigation-arrows">
        {% if navigation.previous and navigation.previous.url %}
        <div class="nav-arrow nav-arrow-left" id="navArrowLeft">
            <a href="{{ navigation.previous.url }}" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"></path>
                </svg>
                <span class="nav-tooltip">Previous: {{ navigation.previous.name }}</span>
            </a>
        </div>
        {% endif %}

        {% if navigation.next and navigation.next.url %}
        <div class="nav-arrow nav-arrow-right" id="navArrowRight">
            <a href="{{ navigation.next.url }}" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"></path>
                </svg>
                <span class="nav-tooltip">Next: {{ navigation.next.name }}</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Session Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ data_type|title }} Detail:
                        {% if data_type == "conduit" %}{{ conduit.conduit_name }}{% endif %}
                        {% if data_type == "node" %}{{ node.node_name }}{% endif %}
                        {% if data_type == "subcatchment" %}{{ subcatchment.subcatchment_name }}{% endif %}
                    </h4>
                    <div class="d-flex gap-2">
                        <a href="{% url 'sa:analysis_results' session.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Results
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Session:</strong> Session {{ session.id }}
                        </div>
                        <div class="col-md-4">
                            <strong>Created:</strong> {{ session.created_at|date:"M d, Y H:i" }}
                        </div>
                        <div class="col-md-4">
                            <strong>Frost Zone:</strong> {{ session.frost_zone }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Main Data Panel -->
        <div class="col-lg-8">
            <!-- Conduit Diagram -->
            {% if data_type == "conduit" %}
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-drafting-compass me-2"></i>
                            Technical Diagram
                        </h5>
                        <button id="reset-zoom" class="btn btn-outline-primary">
                            <i class="fas fa-expand-arrows-alt me-1"></i>Reset View
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="conduit-diagram" class="technical-diagram"></div>
                </div>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        {% if data_type == "conduit" %}Conduit{% endif %}
                        {% if data_type == "node" %}Node{% endif %}
                        {% if data_type == "subcatchment" %}Subcatchment{% endif %}
                        Properties
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Property</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if data_type == "conduit" %}
                                    <tr><td><strong>Name</strong></td><td>{{ conduit.conduit_name }}</td></tr>
                                    <tr><td>Inlet Node</td><td>{{ conduit.inlet_node }}</td></tr>
                                    <tr><td>Outlet Node</td><td>{{ conduit.outlet_node }}</td></tr>
                                    <tr><td>Length</td><td>{{ conduit.length|floatformat:2 }} m</td></tr>
                                    <tr><td>Diameter</td><td>{{ conduit.geom1|floatformat:2 }} m</td></tr>
                                    <tr><td>Max Velocity</td><td>{{ conduit.max_v|floatformat:2 }} m/s</td></tr>
                                    <tr><td>Filling</td><td>{{ conduit.filling|floatformat:2 }} m</td></tr>
                                    <tr><td>Slope</td><td>{{ conduit.slope_per_mile|floatformat:4 }}‰</td></tr>
                                    <tr><td>Min Required Slope</td><td>{{ conduit.min_required_slope|floatformat:4 }}‰</td></tr>
                                    <tr><td>Max Allowable Slope</td><td>{{ conduit.max_allowable_slope|floatformat:4 }}‰</td></tr>
                                    <tr><td>Inlet Ground Elevation</td><td>{{ conduit.inlet_ground_elevation|floatformat:2 }} m</td></tr>
                                    <tr><td>Outlet Ground Elevation</td><td>{{ conduit.outlet_ground_elevation|floatformat:2 }} m</td></tr>
                                    <tr><td>Inlet Ground Cover</td><td>{{ conduit.inlet_ground_cover|floatformat:2 }} m</td></tr>
                                    <tr><td>Outlet Ground Cover</td><td>{{ conduit.outlet_ground_cover|floatformat:2 }} m</td></tr>
                                    <tr><td>Subcatchment</td><td>{{ conduit.subcatchment }}</td></tr>
                                    <tr><td>Subcatchment Category</td><td>{{ conduit.sbc_category }}</td></tr>
                                    <tr><td>Recommendation</td><td>{{ conduit.recommendation }}</td></tr>
                                {% endif %}

                                {% if data_type == "node" %}
                                    <tr><td><strong>Name</strong></td><td>{{ node.node_name }}</td></tr>
                                    <tr><td>Max Depth</td><td>{% if node.max_depth %}{{ node.max_depth|floatformat:2 }} m{% else %}N/A{% endif %}</td></tr>
                                    <tr><td>Invert Elevation</td><td>{% if node.invert_elevation %}{{ node.invert_elevation|floatformat:2 }} m{% else %}N/A{% endif %}</td></tr>
                                    <tr><td>Subcatchment</td><td>{{ node.subcatchment }}</td></tr>
                                    <tr><td>Subcatchment Category</td><td>{{ node.sbc_category }}</td></tr>
                                    <tr><td>Session ID</td><td>{{ node.session.id }}</td></tr>
                                {% endif %}

                                {% if data_type == "subcatchment" %}
                                    <tr><td><strong>Name</strong></td><td>{{ subcatchment.subcatchment_name }}</td></tr>
                                    <tr><td>Outlet</td><td>{{ subcatchment.outlet }}</td></tr>
                                    <tr><td>Area</td><td>{{ subcatchment.area|floatformat:2 }} ha</td></tr>
                                    <tr><td>Imperviousness</td><td>{{ subcatchment.perc_imperv|floatformat:1 }}%</td></tr>
                                    <tr><td>Slope</td><td>{{ subcatchment.perc_slope|floatformat:3 }}%</td></tr>
                                    <tr><td>Category</td><td>{{ subcatchment.category }}</td></tr>
                                    {% if subcatchment.total_runoff_mg %}<tr><td>Total Runoff</td><td>{{ subcatchment.total_runoff_mg|floatformat:2 }} MG</td></tr>{% endif %}
                                    {% if subcatchment.peak_runoff %}<tr><td>Peak Runoff</td><td>{{ subcatchment.peak_runoff|floatformat:2 }} CFS</td></tr>{% endif %}
                                    {% if subcatchment.runoff_coeff %}<tr><td>Runoff Coefficient</td><td>{{ subcatchment.runoff_coeff|floatformat:3 }}</td></tr>{% endif %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar with Related Data -->
        <div class="col-lg-4">
            {% if data_type == "conduit" %}
                <!-- Binary Validation Results - Modern Design -->
                <div class="card mb-4 validation-card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-clipboard-check me-2"></i>
                            Validation Results
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        {% with total_checks=7 passed_checks=conduit.val_max_fill|add:conduit.val_max_v|add:conduit.val_min_v|add:conduit.val_max_slope|add:conduit.val_min_slope|add:conduit.val_depth|add:conduit.val_coverage %}
                        <!-- Summary Header -->
                        <div class="validation-summary {% if passed_checks == total_checks %}status-success{% elif passed_checks >= 5 %}status-warning{% else %}status-danger{% endif %}">
                            <div class="summary-score">
                                <span class="score-value">{{ passed_checks }}</span>
                                <span class="score-divider">/</span>
                                <span class="score-total">{{ total_checks }}</span>
                            </div>
                            <div class="summary-label">
                                {% if passed_checks == total_checks %}All checks passed{% elif passed_checks >= 5 %}Minor issues{% else %}Attention required{% endif %}
                            </div>
                        </div>
                        {% endwith %}

                        <!-- Validation Items -->
                        <ul class="validation-list">
                            <li class="validation-item {% if conduit.val_max_fill %}is-valid{% else %}is-invalid{% endif %}">
                                <span class="validation-indicator"></span>
                                <span class="validation-label">Max Filling</span>
                                <span class="validation-status">{% if conduit.val_max_fill %}Pass{% else %}Fail{% endif %}</span>
                            </li>
                            <li class="validation-item {% if conduit.val_max_v %}is-valid{% else %}is-invalid{% endif %}">
                                <span class="validation-indicator"></span>
                                <span class="validation-label">Max Velocity</span>
                                <span class="validation-status">{% if conduit.val_max_v %}Pass{% else %}Fail{% endif %}</span>
                            </li>
                            <li class="validation-item {% if conduit.val_min_v %}is-valid{% else %}is-invalid{% endif %}">
                                <span class="validation-indicator"></span>
                                <span class="validation-label">Min Velocity</span>
                                <span class="validation-status">{% if conduit.val_min_v %}Pass{% else %}Fail{% endif %}</span>
                            </li>
                            <li class="validation-item {% if conduit.val_max_slope %}is-valid{% else %}is-invalid{% endif %}">
                                <span class="validation-indicator"></span>
                                <span class="validation-label">Max Slope</span>
                                <span class="validation-status">{% if conduit.val_max_slope %}Pass{% else %}Fail{% endif %}</span>
                            </li>
                            <li class="validation-item {% if conduit.val_min_slope %}is-valid{% else %}is-invalid{% endif %}">
                                <span class="validation-indicator"></span>
                                <span class="validation-label">Min Slope</span>
                                <span class="validation-status">{% if conduit.val_min_slope %}Pass{% else %}Fail{% endif %}</span>
                            </li>
                            <li class="validation-item {% if conduit.val_depth %}is-valid{% else %}is-invalid{% endif %}">
                                <span class="validation-indicator"></span>
                                <span class="validation-label">Depth</span>
                                <span class="validation-status">{% if conduit.val_depth %}Pass{% else %}Fail{% endif %}</span>
                            </li>
                            <li class="validation-item {% if conduit.val_coverage %}is-valid{% else %}is-invalid{% endif %}">
                                <span class="validation-indicator"></span>
                                <span class="validation-label">Coverage</span>
                                <span class="validation-status">{% if conduit.val_coverage %}Pass{% else %}Fail{% endif %}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Technical Recommendations - Modern Design -->
                <div class="card mb-4 metrics-card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-ruler-combined me-2"></i>
                            Technical Analysis
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <!-- Diameter Section -->
                        <div class="metrics-section">
                            <div class="metrics-section-header">
                                <span class="section-title">Diameter</span>
                                <span class="section-status {% if conduit.geom1 >= conduit.min_diameter %}status-ok{% else %}status-warning{% endif %}">
                                    {% if conduit.geom1 >= conduit.min_diameter %}OK{% else %}Action needed{% endif %}
                                </span>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <span class="metric-label">Current</span>
                                    <span class="metric-value">{{ conduit.geom1|floatformat:3 }}<span class="metric-unit">m</span></span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Required min.</span>
                                    <span class="metric-value">{{ conduit.min_diameter|floatformat:3 }}<span class="metric-unit">m</span></span>
                                </div>
                            </div>
                            <div class="metrics-actions">
                                <div class="action-item {% if conduit.increase_dia %}is-active{% endif %}">
                                    <span class="action-indicator"></span>
                                    <span class="action-label">Increase</span>
                                    {% if conduit.increase_dia %}<span class="action-target">→ {{ conduit.min_diameter|floatformat:3 }}m</span>{% endif %}
                                </div>
                                <div class="action-item {% if conduit.reduce_dia %}is-possible{% endif %}">
                                    <span class="action-indicator"></span>
                                    <span class="action-label">Reduce</span>
                                    {% if conduit.reduce_dia %}<span class="action-target">possible</span>{% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Slope Section -->
                        <div class="metrics-section">
                            <div class="metrics-section-header">
                                <span class="section-title">Slope</span>
                                <span class="section-status {% if conduit.slope_per_mile >= conduit.min_required_slope and conduit.slope_per_mile <= conduit.max_allowable_slope %}status-ok{% else %}status-warning{% endif %}">
                                    {% if conduit.slope_per_mile >= conduit.min_required_slope and conduit.slope_per_mile <= conduit.max_allowable_slope %}OK{% else %}Action needed{% endif %}
                                </span>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <span class="metric-label">Current</span>
                                    <span class="metric-value">{{ conduit.slope_per_mile|floatformat:2 }}<span class="metric-unit">‰</span></span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Range</span>
                                    <span class="metric-value metric-range">{{ conduit.min_required_slope|floatformat:2 }} – {{ conduit.max_allowable_slope|floatformat:2 }}<span class="metric-unit">‰</span></span>
                                </div>
                            </div>
                            <div class="metrics-actions">
                                <div class="action-item {% if conduit.increase_slope %}is-active{% endif %}">
                                    <span class="action-indicator"></span>
                                    <span class="action-label">Increase</span>
                                    {% if conduit.increase_slope %}<span class="action-target">→ {{ conduit.min_required_slope|floatformat:2 }}‰</span>{% endif %}
                                </div>
                                <div class="action-item {% if conduit.reduce_slope %}is-active{% endif %}">
                                    <span class="action-indicator"></span>
                                    <span class="action-label">Reduce</span>
                                    {% if conduit.reduce_slope %}<span class="action-target">→ {{ conduit.max_allowable_slope|floatformat:2 }}‰</span>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Neural Network Prediction - Modern Design -->
                <div class="card mb-4 predictions-card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-brain me-2"></i>
                            ML Prediction
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <!-- Selected Prediction -->
                        <div class="prediction-selected">
                            <div class="selected-label">Recommended Action</div>
                            <div class="selected-value">{{ conduit.recommendation|title }}</div>
                        </div>

                        <!-- Confidence Distribution -->
                        <ul class="prediction-list">
                            <li class="prediction-item {% if conduit.recommendation == 'valid' %}is-selected{% endif %}">
                                <span class="prediction-name">Valid (No Changes)</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_valid|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_valid|to_percent }}%</span>
                            </li>
                            <li class="prediction-item {% if conduit.recommendation == 'diameter_increase' %}is-selected{% endif %}">
                                <span class="prediction-name">Diameter ↑</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_diameter_increase|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_diameter_increase|to_percent }}%</span>
                            </li>
                            <li class="prediction-item {% if conduit.recommendation == 'diameter_reduction' %}is-selected{% endif %}">
                                <span class="prediction-name">Diameter ↓</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_diameter_reduction|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_diameter_reduction|to_percent }}%</span>
                            </li>
                            <li class="prediction-item {% if conduit.recommendation == 'slope_increase' %}is-selected{% endif %}">
                                <span class="prediction-name">Slope ↑</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_slope_increase|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_slope_increase|to_percent }}%</span>
                            </li>
                            <li class="prediction-item {% if conduit.recommendation == 'slope_reduction' %}is-selected{% endif %}">
                                <span class="prediction-name">Slope ↓</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_slope_reduction|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_slope_reduction|to_percent }}%</span>
                            </li>
                            <li class="prediction-item {% if conduit.recommendation == 'depth_increase' %}is-selected{% endif %}">
                                <span class="prediction-name">Depth ↑</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_depth_increase|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_depth_increase|to_percent }}%</span>
                            </li>
                            <li class="prediction-item {% if conduit.recommendation == 'pump' %}is-selected{% endif %}">
                                <span class="prediction-name">Pump</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_pump|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_pump|to_percent }}%</span>
                            </li>
                            <li class="prediction-item {% if conduit.recommendation == 'tank' %}is-selected{% endif %}">
                                <span class="prediction-name">Tank</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_tank|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_tank|to_percent }}%</span>
                            </li>
                            <li class="prediction-item {% if conduit.recommendation == 'seepage_boxes' %}is-selected{% endif %}">
                                <span class="prediction-name">Seepage Boxes</span>
                                <div class="prediction-bar-wrapper">
                                    <div class="prediction-bar" style="width: {{ conduit.confidence_seepage_boxes|to_percent }}%;"></div>
                                </div>
                                <span class="prediction-percent">{{ conduit.confidence_seepage_boxes|to_percent }}%</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Connected Elements - Modern Design -->
                <div class="card connections-card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-sitemap me-2"></i>
                            Connections
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <ul class="connections-list">
                            {% if inlet_node %}
                            <li class="connection-item">
                                <span class="connection-type">Inlet</span>
                                <a href="{% url 'sa:node_detail' session.id inlet_node.node_name %}" class="connection-link">
                                    <span class="connection-icon node-icon"></span>
                                    <span class="connection-name">{{ inlet_node.node_name }}</span>
                                    <span class="connection-arrow">→</span>
                                </a>
                            </li>
                            {% endif %}
                            {% if outlet_node %}
                            <li class="connection-item">
                                <span class="connection-type">Outlet</span>
                                <a href="{% url 'sa:node_detail' session.id outlet_node.node_name %}" class="connection-link">
                                    <span class="connection-icon node-icon"></span>
                                    <span class="connection-name">{{ outlet_node.node_name }}</span>
                                    <span class="connection-arrow">→</span>
                                </a>
                            </li>
                            {% endif %}
                            {% if subcatchment %}
                            <li class="connection-item">
                                <span class="connection-type">Catchment</span>
                                <a href="{% url 'sa:subcatchment_detail' session.id subcatchment.subcatchment_name %}" class="connection-link">
                                    <span class="connection-icon catchment-icon"></span>
                                    <span class="connection-name">{{ subcatchment.subcatchment_name }}</span>
                                    <span class="connection-arrow">→</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            {% endif %}

            {% if data_type == "node" %}
                <!-- Connected Conduits -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Conduits
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_conduits %}
                            {% for conduit in related_conduits %}
                            <div class="mb-2">
                                <a href="{% url 'sa:conduit_detail' session.id conduit.conduit_name %}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="fas fa-stream me-1"></i>{{ conduit.conduit_name }}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No connected conduits found.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Connected Subcatchments -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Elements - Subcatchments
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_subcatchments %}
                            {% for subcatchment in related_subcatchments %}
                            <div class="mb-2">
                                <a href="{% url 'sa:subcatchment_detail' session.id subcatchment.subcatchment_name %}" class="btn btn-sm btn-outline-success w-100">
                                    <i class="fas fa-map me-1"></i>{{ subcatchment.subcatchment_name }}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No connected subcatchments found.</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            {% if data_type == "subcatchment" %}
                <!-- Connected Conduits -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Conduits
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_conduits %}
                            {% for conduit in related_conduits %}
                            <div class="mb-2">
                                <a href="{% url 'sa:conduit_detail' session.id conduit.conduit_name %}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="fas fa-stream me-1"></i>{{ conduit.conduit_name }}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No related conduits found.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Connected Nodes -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Elements - Nodes
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_nodes %}
                            {% for node in related_nodes %}
                            <div class="mb-2">
                                <a href="{% url 'sa:node_detail' session.id node.node_name %}" class="btn btn-sm btn-outline-info w-100">
                                    <i class="fas fa-circle me-1"></i>{{ node.node_name }}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No connected nodes found.</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if data_type == "conduit" %}
<!-- Conduit data for diagram -->
<script id="conduit-data" type="application/json">
{{ conduit_json|safe }}
</script>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if data_type == "conduit" %}
<!-- SVG.js Library -->
<script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
<!-- Conduit Diagram -->
<script src="{% static 'js/conduit-diagram.js' %}"></script>
{% endif %}
{% endblock %}
