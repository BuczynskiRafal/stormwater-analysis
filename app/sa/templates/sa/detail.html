{% extends "base.html" %}
{% load static %}
{% load confidence_filters %}

{% block title %}{{ data_type|title }} Detail - Session {{ session.id }}{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- Navigation Arrows -->
    <div class="navigation-arrows">
        {% if navigation.previous and navigation.previous.url %}
        <div class="nav-arrow nav-arrow-left" id="navArrowLeft">
            <a href="{{ navigation.previous.url }}" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"></path>
                </svg>
                <span class="nav-tooltip">Previous: {{ navigation.previous.name }}</span>
            </a>
        </div>
        {% endif %}

        {% if navigation.next and navigation.next.url %}
        <div class="nav-arrow nav-arrow-right" id="navArrowRight">
            <a href="{{ navigation.next.url }}" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"></path>
                </svg>
                <span class="nav-tooltip">Next: {{ navigation.next.name }}</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Session Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ data_type|title }} Detail:
                        {% if data_type == "conduit" %}{{ conduit.conduit_name }}{% endif %}
                        {% if data_type == "node" %}{{ node.node_name }}{% endif %}
                        {% if data_type == "subcatchment" %}{{ subcatchment.subcatchment_name }}{% endif %}
                    </h4>
                    <div class="d-flex gap-2">
                        <a href="{% url 'sa:analysis_results' session.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Results
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Session:</strong> Session {{ session.id }}
                        </div>
                        <div class="col-md-4">
                            <strong>Created:</strong> {{ session.created_at|date:"M d, Y H:i" }}
                        </div>
                        <div class="col-md-4">
                            <strong>Frost Zone:</strong> {{ session.frost_zone }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Main Data Panel -->
        <div class="col-lg-8">
            <!-- Conduit Diagram -->
            {% if data_type == "conduit" %}
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-drafting-compass me-2"></i>
                            Technical Diagram
                        </h5>
                        <button id="reset-zoom" class="btn btn-outline-primary">
                            <i class="fas fa-expand-arrows-alt me-1"></i>Reset View
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="conduit-diagram" class="technical-diagram"></div>
                </div>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        {% if data_type == "conduit" %}Conduit{% endif %}
                        {% if data_type == "node" %}Node{% endif %}
                        {% if data_type == "subcatchment" %}Subcatchment{% endif %}
                        Properties
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Property</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if data_type == "conduit" %}
                                    <tr><td><strong>Name</strong></td><td>{{ conduit.conduit_name }}</td></tr>
                                    <tr><td>Inlet Node</td><td>{{ conduit.inlet_node }}</td></tr>
                                    <tr><td>Outlet Node</td><td>{{ conduit.outlet_node }}</td></tr>
                                    <tr><td>Length</td><td>{{ conduit.length|floatformat:2 }} m</td></tr>
                                    <tr><td>Diameter</td><td>{{ conduit.geom1|floatformat:2 }} m</td></tr>
                                    <tr><td>Max Velocity</td><td>{{ conduit.max_v|floatformat:2 }} m/s</td></tr>
                                    <tr><td>Filling</td><td>{{ conduit.filling|floatformat:2 }} m</td></tr>
                                    <tr><td>Slope</td><td>{{ conduit.slope_per_mile|floatformat:4 }}‰</td></tr>
                                    <tr><td>Min Required Slope</td><td>{{ conduit.min_required_slope|floatformat:4 }}‰</td></tr>
                                    <tr><td>Max Allowable Slope</td><td>{{ conduit.max_allowable_slope|floatformat:4 }}‰</td></tr>
                                    <tr><td>Inlet Ground Elevation</td><td>{{ conduit.inlet_ground_elevation|floatformat:2 }} m</td></tr>
                                    <tr><td>Outlet Ground Elevation</td><td>{{ conduit.outlet_ground_elevation|floatformat:2 }} m</td></tr>
                                    <tr><td>Inlet Ground Cover</td><td>{{ conduit.inlet_ground_cover|floatformat:2 }} m</td></tr>
                                    <tr><td>Outlet Ground Cover</td><td>{{ conduit.outlet_ground_cover|floatformat:2 }} m</td></tr>
                                    <tr><td>Subcatchment</td><td>{{ conduit.subcatchment }}</td></tr>
                                    <tr><td>Subcatchment Category</td><td>{{ conduit.sbc_category }}</td></tr>
                                    <tr><td>Recommendation</td><td>{{ conduit.recommendation }}</td></tr>
                                {% endif %}

                                {% if data_type == "node" %}
                                    <tr><td><strong>Name</strong></td><td>{{ node.node_name }}</td></tr>
                                    <tr><td>Max Depth</td><td>{% if node.max_depth %}{{ node.max_depth|floatformat:2 }} m{% else %}N/A{% endif %}</td></tr>
                                    <tr><td>Invert Elevation</td><td>{% if node.invert_elevation %}{{ node.invert_elevation|floatformat:2 }} m{% else %}N/A{% endif %}</td></tr>
                                    <tr><td>Subcatchment</td><td>{{ node.subcatchment }}</td></tr>
                                    <tr><td>Subcatchment Category</td><td>{{ node.sbc_category }}</td></tr>
                                    <tr><td>Session ID</td><td>{{ node.session.id }}</td></tr>
                                {% endif %}

                                {% if data_type == "subcatchment" %}
                                    <tr><td><strong>Name</strong></td><td>{{ subcatchment.subcatchment_name }}</td></tr>
                                    <tr><td>Outlet</td><td>{{ subcatchment.outlet }}</td></tr>
                                    <tr><td>Area</td><td>{{ subcatchment.area|floatformat:2 }} ha</td></tr>
                                    <tr><td>Imperviousness</td><td>{{ subcatchment.perc_imperv|floatformat:1 }}%</td></tr>
                                    <tr><td>Slope</td><td>{{ subcatchment.perc_slope|floatformat:3 }}%</td></tr>
                                    <tr><td>Category</td><td>{{ subcatchment.category }}</td></tr>
                                    {% if subcatchment.total_runoff_mg %}<tr><td>Total Runoff</td><td>{{ subcatchment.total_runoff_mg|floatformat:2 }} MG</td></tr>{% endif %}
                                    {% if subcatchment.peak_runoff %}<tr><td>Peak Runoff</td><td>{{ subcatchment.peak_runoff|floatformat:2 }} CFS</td></tr>{% endif %}
                                    {% if subcatchment.runoff_coeff %}<tr><td>Runoff Coefficient</td><td>{{ subcatchment.runoff_coeff|floatformat:3 }}</td></tr>{% endif %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar with Related Data -->
        <div class="col-lg-4">
            {% if data_type == "conduit" %}
                <!-- Binary Validation Results -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-clipboard-check me-2"></i>
                            Binary Validation Results
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Validation Summary -->
                        <div class="mb-3">
                            {% with total_checks=7 passed_checks=conduit.val_max_fill|add:conduit.val_max_v|add:conduit.val_min_v|add:conduit.val_max_slope|add:conduit.val_min_slope|add:conduit.val_depth|add:conduit.val_coverage %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Overall Status:</strong>
                                <span class="badge bg-{% if passed_checks == total_checks %}success{% elif passed_checks >= 5 %}warning{% else %}danger{% endif %} fs-6">
                                    {{ passed_checks }}/{{ total_checks }} Passed
                                </span>
                            </div>
                            <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar bg-{% if passed_checks == total_checks %}success{% elif passed_checks >= 5 %}warning{% else %}danger{% endif %}"
                                     style="width: {% widthratio passed_checks total_checks 100 %}%"></div>
                            </div>
                            {% endwith %}
                        </div>

                        <!-- Individual Validation Results -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_max_fill %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_max_fill %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Max Filling</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_max_fill %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_max_fill %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_max_v %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_max_v %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Max Velocity</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_max_v %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_max_v %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_min_v %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_min_v %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Min Velocity</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_min_v %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_min_v %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_max_slope %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_max_slope %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Max Slope</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_max_slope %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_max_slope %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_min_slope %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_min_slope %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Min Slope</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_min_slope %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_min_slope %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_depth %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_depth %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Depth</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_depth %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_depth %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-center justify-content-between p-2 rounded border {% if conduit.val_coverage %}bg-light-success{% else %}bg-light-danger{% endif %}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if conduit.val_coverage %}check-circle text-success{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        <span class="fw-bold">Coverage</span>
                                    </div>
                                    <span class="badge bg-{% if conduit.val_coverage %}success{% else %}danger{% endif %}">
                                        {% if conduit.val_coverage %}PASS{% else %}FAIL{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technical Recommendations -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Technical Recommendations
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Diameter Recommendations -->
                        <div class="mb-4 ">
                            <h6 class="mb-3 ">
                                <i class="fas fa-circle me-1"></i>
                                Diameter Analysis
                            </h6>

                            <div class="row g-3">
                                <!-- Current vs Minimum Required -->
                                <div class="col-12">
                                    <div class="card border-left-secondary">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold">Current Diameter</span>
                                                <span class="badge bg-secondary fs-6">{{ conduit.geom1|floatformat:3 }} m</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold">Minimum Required</span>
                                                <span class="badge bg-info fs-6">{{ conduit.min_diameter|floatformat:3 }} m</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                {% if conduit.geom1 >= conduit.min_diameter %}
                                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                                {% else %}
                                                    <div class="progress-bar bg-danger" style="width: {% widthratio conduit.geom1 conduit.min_diameter 100 %}%"></div>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">
                                                {% if conduit.geom1 >= conduit.min_diameter %}
                                                    ✓ Current diameter meets minimum requirements
                                                {% else %}
                                                    ⚠️ Current diameter below minimum required
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Diameter Recommendations -->
                                <div class="col-md-6">
                                    <div class="p-3 rounded border {% if conduit.increase_dia %}bg-warning-subtle border-warning{% else %}bg-light{% endif %}">
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-{% if conduit.increase_dia %}arrow-up text-warning{% else %}equals text-muted{% endif %} me-2"></i>
                                                <span class="fw-bold">Increase Diameter</span>
                                            </div>
                                            <span class="badge bg-{% if conduit.increase_dia %}warning{% else %}success{% endif %}">
                                                {% if conduit.increase_dia %}REQUIRED{% else %}NOT NEEDED{% endif %}
                                            </span>
                                        </div>
                                        {% if conduit.increase_dia %}
                                        <small class="text-muted">
                                            Suggested: {{ conduit.min_diameter|floatformat:3 }} m
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="p-3 rounded border {% if conduit.reduce_dia %}bg-info-subtle border-info{% else %}bg-light{% endif %}">
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-{% if conduit.reduce_dia %}arrow-down text-info{% else %}equals text-muted{% endif %} me-2"></i>
                                                <span class="fw-bold">Reduce Diameter</span>
                                            </div>
                                            <span class="badge bg-{% if conduit.reduce_dia %}info{% else %}success{% endif %}">
                                                {% if conduit.reduce_dia %}POSSIBLE{% else %}NOT POSSIBLE{% endif %}
                                            </span>
                                        </div>
                                        {% if conduit.reduce_dia %}
                                        <small class="text-muted">
                                            Minimum: {{ conduit.min_diameter|floatformat:3 }} m
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Slope Recommendations -->
                        <div class="mb-3">
                            <h6 class="mb-3">
                                <i class="fas fa-chart-line me-1"></i>
                                Slope Analysis
                            </h6>

                            <div class="row g-3">
                                <!-- Current vs Required Range -->
                                <div class="col-12">
                                    <div class="card border-left-secondary">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold">Current Slope</span>
                                                <span class="badge bg-secondary fs-6">{{ conduit.slope_per_mile|floatformat:4 }}‰</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-bold">Required Range</span>
                                                <span class="badge bg-success fs-6">{{ conduit.min_required_slope|floatformat:4 }}‰ - {{ conduit.max_allowable_slope|floatformat:4 }}‰</span>
                                            </div>
                                            <div class="position-relative">
                                                <div class="progress mb-2" style="height: 8px;">
                                                    {% if conduit.slope_per_mile >= conduit.min_required_slope and conduit.slope_per_mile <= conduit.max_allowable_slope %}
                                                        <div class="progress-bar bg-success" style="width: 100%"></div>
                                                    {% elif conduit.slope_per_mile < conduit.min_required_slope %}
                                                        <div class="progress-bar bg-danger" style="width: {% widthratio conduit.slope_per_mile conduit.min_required_slope 100 %}%"></div>
                                                    {% else %}
                                                        <div class="progress-bar bg-warning" style="width: 100%"></div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                {% if conduit.slope_per_mile >= conduit.min_required_slope and conduit.slope_per_mile <= conduit.max_allowable_slope %}
                                                    ✓ Current slope within acceptable range
                                                {% elif conduit.slope_per_mile < conduit.min_required_slope %}
                                                    ⚠️ Current slope below minimum required
                                                {% else %}
                                                    ⚠️ Current slope exceeds maximum allowable
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Slope Recommendations -->
                                <div class="col-md-6">
                                    <div class="p-3 rounded border {% if conduit.increase_slope %}bg-warning-subtle border-warning{% else %}bg-light{% endif %}">
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-{% if conduit.increase_slope %}trending-up text-warning{% else %}equals text-muted{% endif %} me-2"></i>
                                                <span class="fw-bold">Increase Slope</span>
                                            </div>
                                            <span class="badge bg-{% if conduit.increase_slope %}warning{% else %}success{% endif %}">
                                                {% if conduit.increase_slope %}REQUIRED{% else %}NOT NEEDED{% endif %}
                                            </span>
                                        </div>
                                        {% if conduit.increase_slope %}
                                        <small class="text-muted">
                                            Target: {{ conduit.min_required_slope|floatformat:4 }}‰
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="p-3 rounded border {% if conduit.reduce_slope %}bg-info-subtle border-info{% else %}bg-light{% endif %}">
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-{% if conduit.reduce_slope %}trending-down text-info{% else %}equals text-muted{% endif %} me-2"></i>
                                                <span class="fw-bold">Reduce Slope</span>
                                            </div>
                                            <span class="badge bg-{% if conduit.reduce_slope %}info{% else %}success{% endif %}">
                                                {% if conduit.reduce_slope %}REQUIRED{% else %}NOT POSSIBLE{% endif %}
                                            </span>
                                        </div>
                                        {% if conduit.reduce_slope %}
                                        <small class="text-muted">
                                            Target: {{ conduit.max_allowable_slope|floatformat:4 }}‰
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Neural Network Prediction Distribution -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Neural Network Prediction Distribution
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Neural Network Confidence Scores -->
                        <div class="confidence-bars-container">
                            <!-- Pump -->
                            <div class="mb-3 {% if conduit.recommendation == 'pump' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Pump {% if conduit.recommendation == 'pump' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_pump|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_pump|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_pump|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Tank -->
                            <div class="mb-3 {% if conduit.recommendation == 'tank' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Tank {% if conduit.recommendation == 'tank' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_tank|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_tank|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_tank|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Seepage Boxes -->
                            <div class="mb-3 {% if conduit.recommendation == 'seepage_boxes' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Seepage Boxes {% if conduit.recommendation == 'seepage_boxes' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_seepage_boxes|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_seepage_boxes|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_seepage_boxes|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Diameter Increase -->
                            <div class="mb-3 {% if conduit.recommendation == 'diameter_increase' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Diameter Increase {% if conduit.recommendation == 'diameter_increase' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_diameter_increase|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_diameter_increase|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_diameter_increase|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Diameter Reduction -->
                            <div class="mb-3 {% if conduit.recommendation == 'diameter_reduction' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Diameter Reduction {% if conduit.recommendation == 'diameter_reduction' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_diameter_reduction|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_diameter_reduction|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_diameter_reduction|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Slope Increase -->
                            <div class="mb-3 {% if conduit.recommendation == 'slope_increase' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Slope Increase {% if conduit.recommendation == 'slope_increase' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_slope_increase|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_slope_increase|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_slope_increase|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Slope Reduction -->
                            <div class="mb-3 {% if conduit.recommendation == 'slope_reduction' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Slope Reduction {% if conduit.recommendation == 'slope_reduction' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_slope_reduction|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_slope_reduction|to_percent }}%; background-color: #6f42c1;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_slope_reduction|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Depth Increase -->
                            <div class="mb-3 {% if conduit.recommendation == 'depth_increase' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Depth Increase {% if conduit.recommendation == 'depth_increase' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_depth_increase|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar confidence-bar"
                                         style="width: {{ conduit.confidence_depth_increase|to_percent }}%; background-color: #fd7e14;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_depth_increase|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Valid (No Changes) -->
                            <div class="mb-3 {% if conduit.recommendation == 'valid' %}border border-warning rounded p-2{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold">Valid (No Changes) {% if conduit.recommendation == 'valid' %}⭐{% endif %}</small>
                                    <small class="badge bg-success">{{ conduit.confidence_valid|to_percent }}%</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success confidence-bar"
                                         style="width: {{ conduit.confidence_valid|to_percent }}%;">
                                        <span class="text-white fw-bold">{{ conduit.confidence_valid|to_percent }}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
                </div>

                <!-- Connected Nodes -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Elements
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if inlet_node %}
                        <div class="mb-3">
                            <strong>Inlet Node:</strong><br>
                            <a href="{% url 'sa:node_detail' session.id inlet_node.node_name %}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-circle me-1"></i>{{ inlet_node.node_name }}
                            </a>
                        </div>
                        {% endif %}
                        {% if outlet_node %}
                        <div class="mb-3">
                            <strong>Outlet Node:</strong><br>
                            <a href="{% url 'sa:node_detail' session.id outlet_node.node_name %}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-circle me-1"></i>{{ outlet_node.node_name }}
                            </a>
                        </div>
                        {% endif %}
                        {% if subcatchment %}
                        <div class="mb-3">
                            <strong>Subcatchment:</strong><br>
                            <a href="{% url 'sa:subcatchment_detail' session.id subcatchment.subcatchment_name %}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-map me-1"></i>{{ subcatchment.subcatchment_name }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            {% if data_type == "node" %}
                <!-- Connected Conduits -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Conduits
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_conduits %}
                            {% for conduit in related_conduits %}
                            <div class="mb-2">
                                <a href="{% url 'sa:conduit_detail' session.id conduit.conduit_name %}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="fas fa-stream me-1"></i>{{ conduit.conduit_name }}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No connected conduits found.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Connected Subcatchments -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Elements - Subcatchments
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_subcatchments %}
                            {% for subcatchment in related_subcatchments %}
                            <div class="mb-2">
                                <a href="{% url 'sa:subcatchment_detail' session.id subcatchment.subcatchment_name %}" class="btn btn-sm btn-outline-success w-100">
                                    <i class="fas fa-map me-1"></i>{{ subcatchment.subcatchment_name }}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No connected subcatchments found.</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            {% if data_type == "subcatchment" %}
                <!-- Connected Conduits -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Conduits
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_conduits %}
                            {% for conduit in related_conduits %}
                            <div class="mb-2">
                                <a href="{% url 'sa:conduit_detail' session.id conduit.conduit_name %}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="fas fa-stream me-1"></i>{{ conduit.conduit_name }}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No related conduits found.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Connected Nodes -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>
                            Connected Elements - Nodes
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if related_nodes %}
                            {% for node in related_nodes %}
                            <div class="mb-2">
                                <a href="{% url 'sa:node_detail' session.id node.node_name %}" class="btn btn-sm btn-outline-info w-100">
                                    <i class="fas fa-circle me-1"></i>{{ node.node_name }}
                                </a>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No connected nodes found.</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- SVG.js Library -->
<script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
        // Only handle arrow keys if we're not in an input field
        if (event.target.tagName.toLowerCase() === 'input' ||
            event.target.tagName.toLowerCase() === 'textarea' ||
            event.target.contentEditable === 'true') {
            return;
        }

        if (event.key === 'ArrowLeft') {
            event.preventDefault();
            const prevLink = document.querySelector('#navArrowLeft .nav-link');
            if (prevLink) {
                window.location.href = prevLink.href;
            }
        } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            const nextLink = document.querySelector('#navArrowRight .nav-link');
            if (nextLink) {
                window.location.href = nextLink.href;
            }
        }
    });

    // Enhanced hover effects for navigation areas
    const leftNavArea = document.getElementById('navArrowLeft');
    const rightNavArea = document.getElementById('navArrowRight');

    if (leftNavArea) {
        leftNavArea.addEventListener('mouseenter', function() {
            this.style.opacity = '1';
        });

        leftNavArea.addEventListener('mouseleave', function() {
            this.style.opacity = '0';
        });
    }

    if (rightNavArea) {
        rightNavArea.addEventListener('mouseenter', function() {
            this.style.opacity = '1';
        });

        rightNavArea.addEventListener('mouseleave', function() {
            this.style.opacity = '0';
        });
    }

    // Generate conduit diagram if we're on conduit detail page
    {% if data_type == "conduit" %}
    // Add small delay to ensure SVG.js is loaded
    setTimeout(function() {
        if (typeof SVG !== 'undefined') {
            generateConduitDiagram();
        } else {
            console.error('SVG.js not loaded');
        }
    }, 100);
    {% endif %}
});

{% if data_type == "conduit" %}
function generateConduitDiagram() {
    console.log('generateConduitDiagram called');
    const container = document.getElementById('conduit-diagram');

    if (!container) {
        console.error('Container not found');
        return;
    }

    const containerWidth = container.offsetWidth;
    const containerHeight = container.offsetHeight;

    console.log('Container dimensions:', containerWidth, containerHeight);

    // Create SVG canvas
    const draw = SVG().addTo('#conduit-diagram').size(containerWidth, containerHeight);

    // Custom zoom and pan implementation
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let lastMouseX = 0;
    let lastMouseY = 0;

    // Store initial view settings for reset functionality
    let initialScale = 1;
    let initialTranslateX = 0;
    let initialTranslateY = 0;

    const svgElement = draw.node;

    function updateTransform() {
        draw.viewbox(translateX, translateY, containerWidth / scale, containerHeight / scale);
    }

    // Mouse wheel zoom
    svgElement.addEventListener('wheel', function(e) {
        e.preventDefault();
        const rect = svgElement.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.max(0.5, Math.min(5, scale * zoomFactor));

        if (newScale !== scale) {
            const scaleChange = newScale / scale;
            translateX += (mouseX / scale - mouseX / newScale);
            translateY += (mouseY / scale - mouseY / newScale);
            scale = newScale;
            updateTransform();
        }
    });

    // Mouse drag pan
    svgElement.addEventListener('mousedown', function(e) {
        isDragging = true;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        container.style.cursor = 'grabbing';
        e.preventDefault();
    });

    svgElement.addEventListener('mousemove', function(e) {
        if (isDragging) {
            const deltaX = (e.clientX - lastMouseX) / scale;
            const deltaY = (e.clientY - lastMouseY) / scale;
            translateX -= deltaX;
            translateY -= deltaY;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            updateTransform();
        }
    });

    svgElement.addEventListener('mouseup', function() {
        isDragging = false;
        container.style.cursor = 'grab';
    });

    svgElement.addEventListener('mouseleave', function() {
        isDragging = false;
        container.style.cursor = 'grab';
    });

    // Reset zoom functionality
    const resetButton = document.getElementById('reset-zoom');
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            scale = initialScale;
            translateX = initialTranslateX;
            translateY = initialTranslateY;
            updateTransform();
            // Remove focus outline after click
            this.blur();
        });
    }

    // Conduit data from Django template
    const conduitData = {
        name: '{{ conduit.conduit_name }}',
        length: {{ conduit.length }},
        diameter: {{ conduit.geom1 }},
        filling: {{ conduit.filling }},
        inletNode: '{{ conduit.inlet_node }}',
        outletNode: '{{ conduit.outlet_node }}',
        inletElevation: {{ conduit.inlet_ground_elevation }},
        outletElevation: {{ conduit.outlet_ground_elevation }},
        inletCover: {{ conduit.inlet_ground_cover }},
        outletCover: {{ conduit.outlet_ground_cover }},
        slope: {{ conduit.slope_per_mile }}
    };

    // Calculate dimensions and positions
    const margin = 50;
    const pipeLength = containerWidth - 2 * margin - 100; // Space for manholes
    const centerY = containerHeight / 2;
    const manholeWidth = 30;
    const manholeHeight = 80;
    const pipeHeight = 20;

    // Calculate pipe slope visualization
    const slopeExaggeration = 200; // Exaggerate slope for visibility
    const elevationDiff = (conduitData.inletElevation - conduitData.outletElevation) * slopeExaggeration;

    // Calculate ground positions first
    const inletGroundY = centerY - manholeHeight/2 - conduitData.inletCover * 10 - 20;
    const outletGroundY = centerY - manholeHeight/2 - conduitData.outletCover * 10 - 20 + elevationDiff;

    // Define manhole positions (bottom aligned with pipe bottom at each end)
    const inletPipeBottomY = centerY + pipeHeight/2;
    const outletPipeBottomY = centerY + pipeHeight/2 + elevationDiff;

    const inletX = margin;
    const inletY = inletPipeBottomY; // Bottom of inlet manhole = bottom of inlet pipe
    const outletX = containerWidth - margin - manholeWidth;
    const outletY = outletPipeBottomY; // Bottom of outlet manhole = bottom of outlet pipe

    // Continuous green ground line from inlet to outlet
    const inletGroundX = inletX + manholeWidth/2;
    const outletGroundX = outletX + manholeWidth/2;

    draw.line(inletGroundX, inletGroundY, outletGroundX, outletGroundY)
        .stroke({ color: '#228B22', width: 1 });

    // Draw inlet manhole

    // Calculate cylinder height from pipe bottom to ground level (ensure positive)
    const inletCylinderHeight = Math.abs(inletY - inletGroundY); // Distance from pipe bottom to ground level

    // Manhole structure - bottom at pipe level, top at ground level
    draw.rect(manholeWidth, inletCylinderHeight)
        .move(inletX, Math.min(inletY, inletGroundY))
        .fill('none')
        .stroke({ color: '#000000', width: 1 });

    // Manhole cover positioned at ground level
    draw.rect(manholeWidth + 10, 8)
        .move(inletX - 5, inletGroundY - 4)
        .fill('#696969')
        .stroke({ color: '#000000', width: 1 });

    // Axis line through center of inlet manhole (from bottom to top edge of cover)
    const inletAxisX = inletX + manholeWidth/2;
    const inletBottom = Math.max(inletY, inletGroundY);
    const inletCoverBottom = inletGroundY - 4; // Cover bottom position
    const inletCoverTop = inletCoverBottom + 8; // Cover top = bottom + height
    draw.line(inletAxisX, inletBottom, inletAxisX, inletCoverTop)
        .stroke({ color: '#000000', width: 0.5 }).attr('stroke-dasharray', '6,2,1,2');

    // Draw outlet manhole
    // Calculate cylinder height from pipe bottom to ground level (ensure positive)
    const outletCylinderHeight = Math.abs(outletY - outletGroundY); // Distance from pipe bottom to ground level

    // Manhole structure - bottom at pipe level, top at ground level
    draw.rect(manholeWidth, outletCylinderHeight)
        .move(outletX, Math.min(outletY, outletGroundY))
        .fill('none')
        .stroke({ color: '#000000', width: 1 });

    // Manhole cover positioned at ground level
    draw.rect(manholeWidth + 10, 8)
        .move(outletX - 5, outletGroundY - 4)
        .fill('#696969')
        .stroke({ color: '#000000', width: 1 });

    // Axis line through center of outlet manhole (from bottom to top edge of cover)
    const outletAxisX = outletX + manholeWidth/2;
    const outletBottom = Math.max(outletY, outletGroundY);
    const outletCoverBottom = outletGroundY - 4; // Cover bottom position
    const outletCoverTop = outletCoverBottom + 8; // Cover top = bottom + height
    draw.line(outletAxisX, outletBottom, outletAxisX, outletCoverTop)
        .stroke({ color: '#000000', width: 0.5 }).attr('stroke-dasharray', '6,2,1,2');

    // Calculate water level positions in manholes (same level as in pipe)
    const fillingHeightVisual = (conduitData.filling / conduitData.diameter) * pipeHeight;
    const inletWaterLevel = inletPipeBottomY - fillingHeightVisual;
    const outletWaterLevel = outletPipeBottomY - fillingHeightVisual;

    // Draw water in inlet manhole
    const inletManholeBottom = Math.max(inletY, inletGroundY);
    if (inletWaterLevel < inletManholeBottom) {
        draw.rect(manholeWidth, inletManholeBottom - inletWaterLevel)
            .move(inletX, inletWaterLevel)
            .fill('#d5e3f5')
            .opacity(0.4)
            .stroke({ width: 0 });

        // Water level line in inlet manhole
        draw.line(inletX, inletWaterLevel, inletX + manholeWidth, inletWaterLevel)
            .stroke({ color: 'var(--gray-500)', width: 0.5 });
    }

    // Draw water in outlet manhole
    const outletManholeBottom = Math.max(outletY, outletGroundY);
    if (outletWaterLevel < outletManholeBottom) {
        draw.rect(manholeWidth, outletManholeBottom - outletWaterLevel)
            .move(outletX, outletWaterLevel)
            .fill('#d5e3f5')
            .opacity(0.4)
            .stroke({ width: 0 });

        // Water level line in outlet manhole
        draw.line(outletX, outletWaterLevel, outletX + manholeWidth, outletWaterLevel)
            .stroke({ color: 'var(--gray-500)', width: 0.5 });
    }

    // Draw pipe - aligned with manhole bottoms
    const pipeStartX = inletX + manholeWidth;
    const pipeStartY = inletPipeBottomY - pipeHeight; // Top of pipe at manhole bottom
    const pipeEndX = outletX;
    const pipeEndY = outletPipeBottomY - pipeHeight; // Top of pipe at manhole bottom

    // Pipe outline
    draw.polygon([
        [pipeStartX, pipeStartY],
        [pipeEndX, pipeEndY],
        [pipeEndX, pipeEndY + pipeHeight],
        [pipeStartX, pipeStartY + pipeHeight]
    ]).fill('none').stroke({ color: '#000000', width: 1 });

    const waterLevelStartY = pipeStartY + pipeHeight - fillingHeightVisual;
    const waterLevelEndY = pipeEndY + pipeHeight - fillingHeightVisual;

    // Water level inside pipe (filling with blue color)
    draw.polygon([
        [pipeStartX, waterLevelStartY],
        [pipeEndX, waterLevelEndY],
        [pipeEndX, pipeEndY + pipeHeight],
        [pipeStartX, pipeStartY + pipeHeight]
    ]).fill('#d5e3f5').opacity(0.4).stroke({ width: 0 });

    // Draw water level line (top edge of water)
    draw.line(pipeStartX, waterLevelStartY, pipeEndX, waterLevelEndY)
        .stroke({ color: 'var(--gray-500)', width: 0.5  });

    // Add labels and dimensions

    // Conduit name
    draw.text(conduitData.name).move(containerWidth/2, 80).fill('#7a7a7a').font({ size: 20, weight: 'bold' });

    // Calculate table position relative to the lower manhole
    const inletCenterX = inletX + manholeWidth/2;
    const outletCenterX = outletX + manholeWidth/2;

    // Find the lower manhole (higher Y coordinate) and position table below it
    const lowerManholeY = Math.max(inletY, outletY);
    const tableY = lowerManholeY + manholeHeight - 50; // Position table below the lower manhole (reduced spacing)

    const tableStartX = inletCenterX; // Start of table (inlet center)
    const tableEndX = outletCenterX; // End of table (outlet center)
    const dataX = outletX + manholeWidth + 10; // Data position (right of outlet manhole)
    const labelX = inletX - 10; // Labels position (left of inlet manhole)
    const lineHeight = 36; // Height between lines (increased by 4px for wider rows)
    const fontSize = 12; // Font size for data
    const numberFontSize = 10; // Smaller font size for numbers
    const nodeLabelOffset = 30; // Distance above manhole cover for node labels

    // Labels table (left side with border)
    const labelTableWidth = 160; // Width of labels table (increased to fit text)
    const labelTableStartX = labelX - labelTableWidth; // Start of labels table
    const labelTableEndX = labelX; // End of labels table

    // Table structure with complete grid lines
    let currentY = tableY;

    // Labels table border - top line extended to inlet center
    draw.line(labelTableStartX, tableY - 2, inletCenterX, tableY - 2).stroke({ color: '#000', width: 0.5 });

    // Row 1: Ground elevation
    draw.text(`Ground Elevation`).move(labelTableStartX + 5, currentY + lineHeight/2 - 6).fill('#7a7a7a').font({ size: fontSize }).attr('text-anchor', 'start');
    draw.line(tableStartX, currentY - 2, tableEndX, currentY - 2).stroke({ color: '#000', width: 0.5 }); // Top line
    draw.line(tableStartX, currentY + lineHeight - 2, tableEndX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 }); // Bottom line
    draw.line(labelTableStartX, currentY + lineHeight - 2, inletCenterX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 }); // Extended line to inlet center
    // Add ground elevation values to the left of manhole axes (centered in row)
    const labelDataX = inletAxisX - 20; // Position to the left of inlet manhole axis (matching depth row)
    const outletDataX = outletAxisX - 20; // Position to the left of outlet manhole axis (matching depth row)
    draw.text(`${conduitData.inletElevation.toFixed(2)}`).move(labelDataX, currentY + lineHeight/2 - 5).fill('#7a7a7a').font({ size: numberFontSize }).transform({ rotate: 270 });
    draw.text(`${conduitData.outletElevation.toFixed(2)}`).move(outletDataX, currentY + lineHeight/2 - 5).fill('#7a7a7a').font({ size: numberFontSize }).transform({ rotate: 270 });
    currentY += lineHeight;

    // Row 2: Channel bottom elevation
    draw.text(`Invert Elevation`).move(labelTableStartX + 5, currentY + lineHeight/2 - 6).fill('#7a7a7a').font({ size: fontSize }).attr('text-anchor', 'start');
    draw.line(tableStartX, currentY + lineHeight - 2, tableEndX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 });
    draw.line(labelTableStartX, currentY + lineHeight - 2, inletCenterX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 }); // Extended line to inlet center
    // Calculate channel bottom elevation (ground - cover depth)
    const inletBottomElev = (conduitData.inletElevation - conduitData.inletCover).toFixed(2);
    const outletBottomElev = (conduitData.outletElevation - conduitData.outletCover).toFixed(2);
    // Add channel bottom elevation values to the left of manhole axes (centered in row)
    draw.text(`${inletBottomElev}`).move(inletAxisX - 20, currentY + lineHeight/2 - 5).fill('#7a7a7a').font({ size: numberFontSize }).transform({ rotate: 270 });
    draw.text(`${outletBottomElev}`).move(outletAxisX - 20, currentY + lineHeight/2 - 5).fill('#7a7a7a').font({ size: numberFontSize }).transform({ rotate: 270 });
    currentY += lineHeight;

    // Row 3: Channel bottom depth
    draw.text(`Cover Depth`).move(labelTableStartX + 5, currentY + lineHeight/2 - 6).fill('#7a7a7a').font({ size: fontSize }).attr('text-anchor', 'start');
    draw.line(tableStartX, currentY + lineHeight - 2, tableEndX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 });
    draw.line(labelTableStartX, currentY + lineHeight - 2, inletCenterX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 }); // Extended line to inlet center
    // Add depth values to the left of manhole axes (centered in row)
    draw.text(`${conduitData.inletCover.toFixed(2)}`).move(inletAxisX - 16, currentY + lineHeight/2 - 5).fill('#7a7a7a').font({ size: numberFontSize }).transform({ rotate: 270 });
    draw.text(`${conduitData.outletCover.toFixed(2)}`).move(outletAxisX - 16, currentY + lineHeight/2 - 5).fill('#7a7a7a').font({ size: numberFontSize }).transform({ rotate: 270 });
    currentY += lineHeight;

    // Row 4: Channel parameters (diameter, length, slope in one row)
    draw.text(`Diameter, Length, Slope`).move(labelTableStartX + 5, currentY + lineHeight/2 - 6).fill('#7a7a7a').font({ size: fontSize }).attr('text-anchor', 'start');
    draw.line(tableStartX, currentY + lineHeight - 2, tableEndX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 });
    draw.line(labelTableStartX, currentY + lineHeight - 2, inletCenterX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 }); // Extended line to inlet center
    // Place channel parameters in the center of the connecting line (middle of table row)
    const channelParamsX = tableStartX + (tableEndX - tableStartX) / 2;
    draw.text(`Ø ${conduitData.diameter.toFixed(3)} m, L = ${conduitData.length.toFixed(1)} m, i = ${conduitData.slope.toFixed(2)}‰`).move(channelParamsX, currentY + lineHeight/2 - 6).fill('#7a7a7a').font({ size: fontSize }).attr('text-anchor', 'middle');

    // Main table border (vertical lines)
    draw.line(tableStartX, tableY - 2, tableStartX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 });
    draw.line(tableEndX, tableY - 2, tableEndX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 });

    // Labels table border (vertical lines)
    draw.line(labelTableStartX, tableY - 2, labelTableStartX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 });
    draw.line(labelTableEndX, tableY - 2, labelTableEndX, currentY + lineHeight - 2).stroke({ color: '#000', width: 0.5 });

    // Connection lines from table to manhole bottoms
    draw.line(inletCenterX, tableY - 2, inletAxisX, inletBottom).stroke({ color: '#000', width: 0.5 });
    draw.line(outletCenterX, tableY - 2, outletAxisX, outletBottom).stroke({ color: '#000', width: 0.5 });

    // Diameter dimension
    const diameterX = pipeStartX + pipeLength/2;

    // Filling level label at water line with triangle indicator
    const waterLevelMidY = (waterLevelStartY + waterLevelEndY) / 2;
    const fillingPercentage = (conduitData.filling / conduitData.diameter) * 100;

    // Draw triangle indicator - empty triangle with bottom vertex on water line
    const triangleSize = 10;
    const triangleX = diameterX - 15;
    draw.polygon([
        [triangleX - triangleSize/2, waterLevelMidY - triangleSize], // Top left
        [triangleX + triangleSize/2, waterLevelMidY - triangleSize], // Top right
        [triangleX, waterLevelMidY] // Bottom vertex on water line
    ]).fill('none').stroke({ color: '#7a7a7a', width: 0.8 });

    // Add horizontal line at water level starting from triangle vertex (approximately 1cm = 10px)
    const waterLineLength = 10;
    draw.line(triangleX, waterLevelMidY, triangleX + waterLineLength, waterLevelMidY)
        .stroke({ color: '#7a7a7a', width: 0.8 });

    draw.text(`${conduitData.filling.toFixed(2)}m (${fillingPercentage.toFixed(1)}%)`).move(diameterX - 10, waterLevelMidY - 8  - triangleSize - 2).fill('#7a7a7a').font({ size: fontSize });

    // Node labels - positioned above manhole covers and centered on manhole axes (matching table style)
    draw.text(conduitData.inletNode).move(inletAxisX, inletCoverTop - nodeLabelOffset).fill('#7a7a7a').font({ size: fontSize }).attr('text-anchor', 'middle');
    draw.text(conduitData.outletNode).move(outletAxisX, outletCoverTop - nodeLabelOffset).fill('#7a7a7a').font({ size: fontSize }).attr('text-anchor', 'middle');

    // Center the view to include the entire drawing including the table
    // Calculate the full extent of the drawing
    const minX = labelTableStartX - 10; // Left edge of labels table with margin
    const maxX = containerWidth - 10; // Right edge with margin
    const minY = Math.min(inletCoverTop - nodeLabelOffset - 20, outletCoverTop - nodeLabelOffset - 20); // Top of node labels with margin
    const maxY = currentY + lineHeight + 10; // Bottom of table with margin

    const drawingWidth = maxX - minX;
    const drawingHeight = maxY - minY;

    // Calculate scale to fit the drawing with some padding
    const scaleX = containerWidth / drawingWidth;
    const scaleY = containerHeight / drawingHeight;
    const calculatedInitialScale = Math.min(scaleX, scaleY, 1) * 0.9; // 0.9 for 10% padding

    // Calculate center position
    const drawingCenterX = (minX + maxX) / 2;
    const drawingCenterY = (minY + maxY) / 2;
    const calculatedInitialTranslateX = drawingCenterX - (containerWidth / calculatedInitialScale) / 2;
    const calculatedInitialTranslateY = drawingCenterY - (containerHeight / calculatedInitialScale) / 2;

    // Store initial view settings for reset functionality
    initialScale = calculatedInitialScale;
    initialTranslateX = calculatedInitialTranslateX;
    initialTranslateY = calculatedInitialTranslateY;

    // Set initial view
    scale = initialScale;
    translateX = initialTranslateX;
    translateY = initialTranslateY;
    updateTransform();

}
{% endif %}
</script>

{% endblock %}
